name: Deploy Open WebUI to GKE

on:
  push:
    branches:
      - main
    paths:
      - 'terraform/**'
      - 'helm/**'
      - 'scripts/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # Manual trigger

env:
  # Required secrets - only 2 secrets needed!
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  # Optional: OpenRouter API key for 344+ AI models (if not provided, models won't work)
  OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
  # Default values (no secrets needed)
  GCP_REGION: europe-west1
  GCP_ZONE: europe-west1-b
  CLUSTER_NAME: open-webui-cluster
  NAMESPACE: ai
  BACKUP_BUCKET: open-webui-backups
  DOMAIN: ai-k8s.svdevops.tech

jobs:
  deploy:
    name: Deploy Infrastructure and Application
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Diagnostics (gcloud context)
        run: |
          gcloud config list
          gcloud auth list
          gcloud projects describe ${{ env.GCP_PROJECT_ID }} --format='value(projectNumber,projectId)'
          echo "ADC file: ${{ steps.auth.outputs.credentials_file_path }}"
          echo "Env GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-<empty>}"
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.12.0'

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: Deploy Infrastructure
        run: |
          chmod +x ./scripts/deploy-infra.sh
          TF_VAR_project_id=${{ env.GCP_PROJECT_ID }} \
          TF_VAR_region=${{ env.GCP_REGION }} \
          TF_VAR_zone=${{ env.GCP_ZONE }} \
          TF_VAR_cluster_name=${{ env.CLUSTER_NAME }} \
          GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }} \
          GCP_REGION=${{ env.GCP_REGION }} \
          GCP_ZONE=${{ env.GCP_ZONE }} \
          CLUSTER_NAME=${{ env.CLUSTER_NAME }} \
          ./scripts/deploy-infra.sh
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}

      - name: Deploy Application to Kubernetes
        run: |
          chmod +x ./scripts/deploy-to-k8s.sh
          TF_VAR_project_id=${{ env.GCP_PROJECT_ID }} \
          TF_VAR_region=${{ env.GCP_REGION }} \
          TF_VAR_zone=${{ env.GCP_ZONE }} \
          TF_VAR_cluster_name=${{ env.CLUSTER_NAME }} \
          GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }} \
          GCP_REGION=${{ env.GCP_REGION }} \
          GCP_ZONE=${{ env.GCP_ZONE }} \
          CLUSTER_NAME=${{ env.CLUSTER_NAME }} \
          BACKUP_BUCKET=${{ env.BACKUP_BUCKET }} \
          DOMAIN=${{ env.DOMAIN }} \
          OPENROUTER_API_KEY=${{ env.OPENROUTER_API_KEY }} \
          GCP_SA_KEY="${{ secrets.GCP_SA_KEY }}" \
          ./scripts/deploy-to-k8s.sh
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}

      - name: Verify Deployment
        run: |
          echo " Deployment completed!"
          echo "Pod status:"
          kubectl get pods -n ${{ env.NAMESPACE }}
          echo ""
          echo " Ingress status:"
          kubectl get ingress -n ${{ env.NAMESPACE }}
          echo ""
          echo " Application URL: https://${{ env.DOMAIN }}"
