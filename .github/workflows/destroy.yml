name: Destroy Infrastructure

on:
  workflow_dispatch:  # Manual trigger only

env:
  # Required secrets - only 2 secrets needed!
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
  # Default values (no secrets needed)
  GCP_REGION: europe-west1
  GCP_ZONE: europe-west1-b
  CLUSTER_NAME: open-webui-cluster
  NAMESPACE: ai
  BACKUP_BUCKET: open-webui-backups

jobs:
  backup:
    name: Backup Database (if cluster exists)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Diagnostics (gcloud context)
        run: |
          gcloud config list
          gcloud auth list
          gcloud projects describe ${{ env.GCP_PROJECT_ID }} --format='value(projectNumber,projectId)'
          echo "ADC file: ${{ steps.auth.outputs.credentials_file_path }}"
          echo "Env GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS:-<empty>}"
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --zone ${{ env.GCP_ZONE }} \
            --project ${{ env.GCP_PROJECT_ID }} || echo "Cluster does not exist, skipping backup"

      - name: Check if cluster exists
        id: check_cluster
        run: |
          if kubectl cluster-info &>/dev/null; then
            echo "cluster_exists=true" >> $GITHUB_OUTPUT
          else
            echo "cluster_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Backup database
        if: steps.check_cluster.outputs.cluster_exists == 'true'
        run: |
          # Create backup directory
          mkdir -p backups
          
          # Get pod name
          POD_NAME=$(kubectl get pods -n ${{ env.NAMESPACE }} -l app.kubernetes.io/name=open-webui -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
          
          if [ -n "$POD_NAME" ]; then
            echo "ðŸ“¦ Backing up database from pod: $POD_NAME"
            kubectl cp ${{ env.NAMESPACE }}/$POD_NAME:/app/backend/data/webui.db backups/webui_backup_$(date +%Y%m%d_%H%M%S).db
            
            # Upload to GCS
            if [ -n "${{ env.BACKUP_BUCKET }}" ]; then
              echo " Uploading backup to GCS..."
              gsutil mb -p ${{ env.GCP_PROJECT_ID }} -l ${{ env.GCP_REGION }} gs://${{ env.BACKUP_BUCKET }} 2>/dev/null || true
              gsutil cp backups/webui_backup_*.db gs://${{ env.BACKUP_BUCKET }}/latest.db
              gsutil cp backups/webui_backup_*.db gs://${{ env.BACKUP_BUCKET }}/backups/webui_backup_$(date +%Y%m%d_%H%M%S).db
              echo " Backup uploaded to gs://${{ env.BACKUP_BUCKET }}/latest.db"
            fi
          else
            echo "Pod not found, skipping backup"
          fi

      - name: Upload backup artifact
        if: steps.check_cluster.outputs.cluster_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: database-backup
          path: backups/*.db
          retention-days: 30

  destroy:
    name: Destroy Infrastructure
    runs-on: ubuntu-latest
    needs: backup
    if: always()  # Run even if backup fails
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Initialize Terraform
        working-directory: terraform
        run: |
          terraform init
        env:
          TF_VAR_project_id: ${{ env.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ env.GCP_REGION }}
          TF_VAR_zone: ${{ env.GCP_ZONE }}
          TF_VAR_cluster_name: ${{ env.CLUSTER_NAME }}
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}

      - name: Destroy Infrastructure
        run: |
          chmod +x ./scripts/destroy-infra.sh
          TF_VAR_project_id=${{ env.GCP_PROJECT_ID }} \
          TF_VAR_region=${{ env.GCP_REGION }} \
          TF_VAR_zone=${{ env.GCP_ZONE }} \
          TF_VAR_cluster_name=${{ env.CLUSTER_NAME }} \
          GCP_PROJECT_ID=${{ env.GCP_PROJECT_ID }} \
          GCP_REGION=${{ env.GCP_REGION }} \
          GCP_ZONE=${{ env.GCP_ZONE }} \
          CLUSTER_NAME=${{ env.CLUSTER_NAME }} \
          ./scripts/destroy-infra.sh
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ steps.auth.outputs.credentials_file_path }}

